#!/bin/bash
# Post-installation script for KeySwitch

# Get the user who is installing (not root)
CURRENT_USER="${USER}"
if [ -z "$CURRENT_USER" ] || [ "$CURRENT_USER" = "root" ]; then
    CURRENT_USER=$(stat -f "%Su" /dev/console)
fi

# Copy plist to user's LaunchAgents directory
USER_HOME=$(eval echo ~$CURRENT_USER)
mkdir -p "$USER_HOME/Library/LaunchAgents"
cp "/Library/LaunchAgents/com.keyswitch.daemon.plist" "$USER_HOME/Library/LaunchAgents/" 2>/dev/null || true

# Set correct ownership
chown "$CURRENT_USER" "$USER_HOME/Library/LaunchAgents/com.keyswitch.daemon.plist" 2>/dev/null || true

# Try to load the LaunchAgent
if [ -n "$CURRENT_USER" ]; then
    sudo -u "$CURRENT_USER" launchctl load -w "$USER_HOME/Library/LaunchAgents/com.keyswitch.daemon.plist" 2>/dev/null || true
fi

echo "KeySwitch has been installed successfully!"
echo "The daemon will start automatically on next login."

exit 0
